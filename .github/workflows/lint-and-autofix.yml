name: Lint & Autofix

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *'  # daily 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  lint-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Python setup (dev)
        uses: ./.github/actions/python-setup
        with:
          python-version: '3.12'
          install-extras: 'dev'

      - name: Run Ruff (check)
        run: ruff check .

      - name: Run Black (check)
        run: black --check .

  autofix-scheduled:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Python setup (dev)
        uses: ./.github/actions/python-setup
        with:
          python-version: '3.12'
          install-extras: 'dev'

      - name: Apply Ruff fixes
        run: ruff check --fix . || true

      - name: Apply Black fixes
        run: black . || true

      - name: Create patch & PR if changes
        run: |
          if git diff --quiet; then
            echo "No changes after formatting."; exit 0; fi
          BRANCH="autofix/lint-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$BRANCH"
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m 'chore: lint autofixes'
          git push origin "$BRANCH"
          gh pr create --title 'chore: lint autofixes' --body 'Automated Ruff/Black fixes.' --label automation --label lint || echo 'gh CLI not available; skipping PR creation.'
